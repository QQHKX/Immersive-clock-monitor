# 沉浸式噪音监测

> 沉浸式时钟 [Immersive Clock](https://github.com/QQHKX/Immersive-clock) 的衍生作品，专注于公开其独特的噪音监测与评分算法。

## 项目简介

本项目从 [沉浸式时钟](https://github.com/QQHKX/Immersive-clock) 项目中提取并独立了噪音监测模块，旨在公开其基于心理声学与专注力理论的噪音评分引擎。该算法不仅仅是一个简单的分贝计，而是通过多维度加权扣分制，客观量化环境噪音对学习心流的干扰程度。

## 核心特性

### 三维度评分模型

噪音评分系统从三个维度对环境噪音进行评估：

| 维度 | 权重 | 指标 | 满扣分条件 |
|------|------|------|-----------|
| **持续噪音** | 40% | p50Dbfs | 中位数超过阈值 6 dBFS |
| **超阈时长** | 30% | overRatioDbfs | 超阈时间占比 30% |
| **打断频次** | 30% | segmentCount | 6 次/分钟 |

### 评分与校准分离

- **评分只依赖原始 DBFS**：评分的三项核心指标都来自原始 `dbfs` 统计，与校准无关
- **校准仅影响显示分贝**：校准值只用于 UI 展示，不进入评分链路
- 杜绝了通过调整校准值"刷分"的可能性

### 智能事件段合并

系统设有 500ms 的合并窗口，如果两次响声间隔小于该窗口（如拉椅子的一连串声音），会被合并为 1 次打断，只有间隔较长的响声才会被计为新的打断。

## 技术架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户界面层                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ 实时监控组件  │  │ 噪音报告弹窗  │  │ 噪音历史列表  │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              ↑
                              │ 订阅/发布
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        流服务层                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  噪音流服务 - 订阅管理、生命周期控制、设置热更新          │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              ↑
                              │ 帧数据流
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        数据聚合层                                 │
│  ┌──────────────────┐  ┌────────────────────────────────────┐  │
│  │ 噪音帧处理器      │  │ 噪音切片聚合器                      │  │
│  │ - RMS/dBFS 计算   │  │ - 切片聚合、统计指标、评分计算      │  │
│  │ - 50ms/帧         │  │ - 30秒/切片                         │  │
│  └──────────────────┘  └────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 实时环形缓冲区 - 保留固定时长的实时数据                    │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              ↑
                              │ 音频流
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        数据采集层                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 麦克风采集 - Web Audio API、滤波器、AnalyserNode         │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              ↑
                              │ 物理音频
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        数据存储层                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 切片存储 - localStorage、时间清理、容量限制                │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 快速开始

### 安装依赖

```bash
cnpm install
```

### 启动开发服务器

```bash
cnpm run dev
```

### 构建生产版本

```bash
cnpm run build
```

## 技术栈

- **音频处理**：Web Audio API
- **数据存储**：localStorage
- **前端框架**：React 19
- **构建工具**：Vite 6
- **类型系统**：TypeScript 5.8
- **图表库**：Recharts 3

## 核心算法说明

### RMS（均方根）计算

$$ \text{RMS} = \sqrt{\frac{1}{N} \sum_{i=1}^{N} x_i^2} $$

### dBFS（分贝满刻度）转换

$$ \text{dBFS} = 20 \times \log_{10}(\text{RMS}) $$

### 评分公式

$$ \text{TotalPenalty} = 0.40 \times P_{\text{sustained}} + 0.30 \times P_{\text{time}} + 0.30 \times P_{\text{segment}} $$

$$ \text{Score} = 100 \times (1 - \text{TotalPenalty}) $$

## 详细技术文档

完整的噪音计算与评分技术文档请参考 [noise-technical.md](./noise-technical.md)，其中包含：

- 核心理念与设计原则
- 系统架构详解
- 数据采集层实现
- 数据聚合层算法
- 评分算法核心
- 数据存储策略
- 历史报告生成
- 流服务整合
- 配置参数体系
- 完整类型定义

## 与沉浸式时钟的关系

本项目是 [沉浸式时钟](https://github.com/QQHKX/Immersive-clock) 的衍生作品，专注于：

1. **噪音监测模块的独立化**：将噪音监测功能从完整时钟应用中提取出来
2. **算法公开**：公开其独特的噪音评分算法，供学习和研究使用
3. **简化实现**：移除了时钟、倒计时、秒表、天气、课表等其他功能，专注于噪音监测核心

## 功能实现情况

### 已实现功能

- ✅ 实时噪音监测（50ms 采样率）
- ✅ RMS/dBFS 计算
- ✅ 音频滤波器（高通 80Hz，低通 8000Hz）
- ✅ 三维度评分引擎
- ✅ 实时评分显示
- ✅ 噪音历史记录
- ✅ 噪音校准功能
- ✅ 实时波形图表
- ✅ LocalStorage 数据持久化
- ✅ 评分与校准分离机制

### 未实现功能（沉浸式时钟原有功能）

- ❌ 时钟显示
- ❌ 倒计时功能
- ❌ 秒表功能
- ❌ 自习模式
- ❌ 天气监测
- ❌ 励志语录
- ❌ 课表管理
- ❌ 多目标倒计时轮播
- ❌ 背景定制
- ❌ 自定义字体
- ❌ PWA 支持
- ❌ 课表关联的历史报告

## 许可证

本项目遵循原 [沉浸式时钟](https://github.com/QQHKX/Immersive-clock) 项目的许可证。
